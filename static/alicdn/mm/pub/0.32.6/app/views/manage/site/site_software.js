Magix.tmpl("app/views/manage/site/site_software","<div bx-tmpl=\"pageCount\" bx-datakey=\"pageCount,pageNo,pageSize,limited\"> {{^if(pageCount==0)}} <div class=table-head-fix> <div class=\"toolbar clearfix\"> {{#limited}} <span class=\"btn btn-size25 btn-disabled\" bx-name=\"tooltip\" bx-config=\"{closable:false,align:{node:false,points:['tl','bl']},mouseDelay:0.2,width:180,content:'最多只能新增{{maxSiteNum}}个软件推广'}\">新增软件推广</span> {{/limited}} {{^limited}} <a href=\"#\" class=\"btn btn-size25\" mx-click=add data-spm-click=\"gostr=/tblm.88.1;locaid=d779b5b26\">新增软件推广</a> {{/limited}} </div> <table class=table bx-tmpl=\"tableFix\" bx-datakey=\"list\"> <thead> <tr {{^list}}class=no-data{{/list}}> <th class=left width=\"10%\">软件ID</th> <th class=left>软件客户端名称</th> <th class=left width=\"15%\">应用类型</th> <th class=left width=\"15%\">下载地址</th> <th class=left width=\"15%\"> 提交状态 <i class=\"iconfont cursor-pointer fontsize-13 ml2\" bx-name=\"tooltip\" bx-config=\"{closable:false,align:{node:false,points:['tr','br']},mouseDelay:0.2,width:300,content:'提交成功的状态代表您可以获取推广代码进行推广，但并不代表您的渠道或推广行为完全符合相关推广规则，如发现违规，将按<a href=&quot;http://help.alimama.com/#!/u/faq/detail?id=5704248&quot; target=&quot;_blank&quot; class=&quot;color-blue&quot;>相关规则</a>进行处理。'}\">&#360;</i> </th> <th class=left width=\"15%\">拒绝原因</th> <th class=center width=\"15%\">操作</th> </tr> </thead> </table> </div> <table class=table bx-name=\"tables\" bx-tmpl=\"list\" bx-datakey=\"list\"> <tbody> {{#list}} <tr> <td class=left width=\"10%\">{{siteid}}</td> <td class=left>{{name}}</td> <td class=left width=\"15%\"> {{#typename}} {{typename}} {{/typename}} {{^typename}} -- {{/typename}} </td> <td class=left width=\"15%\"> <div style=\"width:100%\"> <a href=\"{{url}}\" target=_blank>{{url}}</a> </div> </td> <td class=left width=\"15%\">{{{list_status}}}</td> <td class=left width=\"15%\"> {{#if(status==R)}} {{#comments}} <div class=table-more> <i class=iconfont>&#299;</i> <i class=icon-horn-tilt></i> <div class=table-info style=\"width: 120px;display: none;\"> {{{comments}}} </div> </div> {{/comments}} {{^comments}} -- {{/comments}} {{/if(status==R)}} {{^if(status==R)}} -- {{/if(status==R)}} </td> <td class=center width=\"15%\"> <p class=operation> {{#autoGeneratedSite}} <span class=color-gray>修改</span> <span class=divide>|</span> <span class=color-gray>删除</span> {{/autoGeneratedSite}} {{^autoGeneratedSite}} <a href=\"#\" mx-click=\"edit{siteId:{{siteid}}}\" data-spm-click=\"gostr=/tblm.88.1;locaid=d9717c285\">修改</a> <span class=divide>|</span> <a href=\"#\" mx-click=\"del{siteId:{{siteid}}}\" data-spm-click=\"gostr=/tblm.88.1;locaid=d93056342\">删除</a> {{/autoGeneratedSite}} </p> </td> </tr> {{/list}} </tbody> </table> <div class=tfoot> <div id=J_item_pagination bx-name=\"pagination\" class=pagination bx-config=\"{count:{{pageCount}},index:{{pageNo}},size:{{pageSize}},sizes:[40],simplify:true,statistics:true,sizeChange:true,jump:true,goTo:false}\"> </div> {{/if(pageCount==0)}} {{#if(pageCount==0)}} <div class=\"create-promo clearfix\"> <div class=promo-img> <img src=\"//img.alicdn.com/tps/TB12lnBKFXXXXXpaXXXXXXXXXXX-200-150.png\"> </div> <div class=promo-info> <p class=color-666>我拥有自己的软件，在软件上部署淘宝联盟推广代码的推广模式。</p> <p class=toolbar> <a href=\"#\" class=\"btn btn-blue btn-size28\" mx-click=add data-spm-click=\"gostr=/tblm.88.1;locaid=d98c2817b\">新建软件推广</a> </p> </div> </div> {{/if(pageCount==0)}} </div>");
KISSY.add('app/views/manage/site/site_software', function (S, Node, View, MM, Util) {
    var $ = Node.all;
    return View.extend({
        init: function (e) {
            var me = this;
            me.observeLocation([
                'toPage',
                'perPageSize'
            ]);
            me.on('save', function (ev) {
                me.render();
            });
        },
        locationChange: function (e) {
            if (this.location.params.tab == 5) {
                this.render();
            }
        },
        render: function () {
            var me = this;
            var loc = me.location;
            var params = S.clone(loc.params);
            params.toPage = params.toPage || 1;
            params.perPageSize = params.perPageSize || 40;
            me.manage(MM.fetchAll([{
                    name: 'software_list',
                    urlParams: params
                }], function (MesModel) {
                var site = MesModel.get('data');
                var list = site.siteList;
                var limited = site.maxSiteNum <= site.paginator.items;
                me.setViewPagelet({
                    list: list,
                    limited: limited,
                    maxSiteNum: site.maxSiteNum,
                    pageCount: site.paginator.items,
                    pageNo: params.toPage,
                    pageSize: params.perPageSize
                }, function () {
                    me.components();
                }, function () {
                    var pageParams = {
                        pageNo: params.toPage,
                        pageSize: params.perPageSize,
                        pageCount: site.paginator.items
                    };
                    me.resetPage(pageParams);
                });
            }));
        },
        components: function () {
            var me = this;
            var pagelet = me.getManaged('pagelet');
            var pagination = pagelet.getBrick('J_item_pagination');
            if (pagination) {
                pagination.on('gotoPage', function (ev) {
                    me.navigate('toPage=' + ev.index);
                });
                pagination.on('sizeChange', function (ev) {
                    me.navigate('toPage=1&perPageSize=' + ev.size);
                });
            }
        },
        resetPage: function (params) {
            var me = this;
            var pagelet = me.getManaged('pagelet');
            var pagination = pagelet.getBrick('J_item_pagination');
            var pageparam = {};
            if (pagination) {
                if (pagination.get('index') != params.pageNo) {
                    pageparam['index'] = params.pageNo;
                }
                if (pagination.get('size') != params.pageSize) {
                    pageparam['size'] = params.pageSize;
                }
                if (pagination.get('count') != params.pageCount) {
                    pageparam['count'] = params.pageCount;
                }
                if (!S.isEmptyObject(pageparam)) {
                    pagination.setConfig(pageparam);
                }
            }
        },
        events: {
            click: {
                add: function (e) {
                    e.halt();
                    var me = e.view;
                    var top = $('#' + e.currentId).parent('.toolbar').offset().top;
                    var dialogConfig = Util.getDefaultDialogConfig({
                        width: 640,
                        top: top
                    });
                    var viewName = 'app/views/manage/site/site_software_add';
                    var viewOptions = { triggerView: e.view };
                    Util.showDialog(dialogConfig, viewName, viewOptions);
                },
                edit: function (e) {
                    e.halt();
                    var me = e.view;
                    var top = $('#' + e.currentId).parent('tr').offset().top;
                    var dialogConfig = Util.getDefaultDialogConfig({
                        width: 640,
                        top: top
                    });
                    var viewName = 'app/views/manage/site/site_software_edit';
                    var viewOptions = {
                        siteId: e.params.siteId,
                        triggerView: e.view
                    };
                    Util.showDialog(dialogConfig, viewName, viewOptions);
                },
                del: function (e) {
                    e.halt();
                    var me = e.view;
                    var top = $('#' + e.currentId).parent('tr').offset().top;
                    var dialogConfig = Util.getDefaultDialogConfig({
                        width: 400,
                        top: top
                    });
                    var viewName = 'app/views/util/confirm';
                    var viewOptions = {
                        confirmFn: function () {
                            me.manage(MM.fetchAll([{
                                    name: 'site_del',
                                    postParams: { ids: e.params.siteId }
                                }], function (MesModel) {
                                Util.hideDialog();
                                me.render();
                            }));
                        },
                        cancelFn: function () {
                            Util.hideDialog();
                        },
                        confirmTitle: '\u5220\u9664\u8F6F\u4EF6',
                        confirmContent: '\u5220\u9664\u8F6F\u4EF6\u524D\u8BF7\u786E\u8BA4\u5DF2\u7ECF\u5220\u9664\u4E86\u8BE5\u8F6F\u4EF6\u4E0B\u7684\u6240\u6709\u63A8\u5E7F\u4F4D\uFF0C\u5220\u9664\u8F6F\u4EF6\u540E\u8BE5\u8F6F\u4EF6\u5BF9\u5E94\u7684\u6240\u6709\u63A8\u5E7F\u4EE3\u7801\u548C\u4EA7\u54C1\u6743\u9650\u7B49\u4FE1\u606F\u90FD\u5C06\u5931\u6548\u3002\u60A8\u786E\u8BA4\u8981\u5220\u9664\u8BE5\u8F6F\u4EF6\u5417\uFF1F\u8BF7\u8C28\u614E\u64CD\u4F5C\uFF01'
                    };
                    Util.showDialog(dialogConfig, viewName, viewOptions);
                }
            }
        },
        renderer: {
            list: {
                status: function (self) {
                    switch (this.status) {
                    case 'W':
                    case 'T':
                        return '<span class="color-orange">\u63D0\u4EA4\u4E2D</span>';
                        break;
                    case 'P':
                        return '<span class="color-green">\u63D0\u4EA4\u6210\u529F</span>';
                        break;
                    case 'R':
                        return '<span class="color-red">\u62D2\u7EDD</span>';
                        break;
                    case 'V':
                        return '<span class="color-red">\u5386\u53F2\u5907\u6848\u5F85\u4FEE\u6539</span>';
                        break;
                    }
                }
            }
        }
    });
}, {
    requires: [
        'node',
        'mxext/view',
        'app/models/modelmanager',
        'app/util/util',
        'mxext/mmanager',
        'app/models/model',
        'app/models/basemodel',
        'mxext/model',
        'ajax',
        'app/util/datepicker/datepicker',
        'app/util/dialog/dialog',
        'app/util/format/format',
        'app/util/globaltip/globaltip',
        'app/util/robot/sourceid',
        'app/util/spmlog/spmlog',
        'app/util/mathextend/mathextend',
        'app/util/tooltip/tooltip',
        'app/util/widgetds/widgetds',
        'app/util/rank/rank',
        'app/util/reporttip/reporttip',
        'app/util/vcode/vcode',
        'app/util/pagination/index',
        'app/util/fields/fields',
        'app/util/mouseevent/index',
        'magix/vframe',
        'magix/vom',
        'magix/router',
        'brix/gallery/datepicker/index',
        'brix/gallery/calendar/index',
        'brix/gallery/dialog/index',
        'app/util/spmlog/pathmap'
    ]
});